#! /usr/bin/env python
import re
import subprocess
import sys

version_regex = re.compile(r"-    version='(.*)'")


def run_command(command):
    result = subprocess.check_output(command.split(' ')).decode('utf-8')
    return result.split('\n')[:-1]


def main(branch):
    stat_diff = run_command(f'git diff {branch} --stat .')
    if not stat_diff:
        print('No diff')
        return 0

    diff = run_command(f'git diff {branch} .')
    version = run_command('python setup.py -V')[0]

    for line in diff:
        match = re.match(version_regex, line)
        if not match:
            continue

        previous_version = match.groups(1)[0]
        if previous_version < version:
            print('The version was bumped')
            return 0

        if previous_version > version:
            print('Version is less than origin/master, you should rebase!')
            return 1

    print('Bump your version! run `make bump`')
    return 1


if __name__ == '__main__':
    try:
        branch = sys.argv[1]
    except IndexError:
        branch = 'origin/master'

    sys.exit(main(branch))
